<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - Pastelería El Caballo Goloso</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <link href="styles/main.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary">
        <div class="container-fluid">
            <button data-mdb-collapse-init class="navbar-toggler" type="button" data-mdb-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
    
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <a class="navbar-brand mt-2 mt-lg-0" href="index.html">
                    <img src="https://mdbcdn.b-cdn.net/img/logo/mdb-transaprent-noshadows.webp" height="15" alt="MDB Logo"
                        loading="lazy" />
                </a>
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="../productos/pasteleria.html">Pastelería</a></li>
                    <li class="nav-item"><a class="nav-link" href="../productos/bolleria.html">Bollería</a></li>
                    <li class="nav-item"><a class="nav-link" href="../productos/salado.html">Repostería Salada</a></li>
                    <li class="nav-item"><a class="nav-link" href="../productos/tartas.html">Tartas</a></li>
                </ul>
            </div>
            <div class="d-flex align-items-center">
                <a class="link-secondary me-3" href="carrito.html"><i class="fas fa-shopping-cart"></i></a>
                <div class="dropdown">
                    <a data-mdb-dropdown-init class="dropdown-toggle d-flex align-items-center hidden-arrow" href="login.html" id="navbarDropdownMenuAvatar" role="button"
                        aria-expanded="false">
                        <img src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp" class="rounded-circle" height="25" alt="User Avatar" loading="lazy" />
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuAvatar">
                        <li><a class="dropdown-item" href="#">My profile</a></li>
                        <li><a class="dropdown-item" href="#">Settings</a></li>
                        <li><a class="dropdown-item" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <main class="container mt-5">
        <h1 class="text-center">Mis Pedidos</h1>
        <div class="d-flex">
            <nav class="me-4">
                <h3 class="text-danger">Sección</h3>
                <ul class="list-unstyled">
                    <li><strong>Pedidos</strong></li>
                    <li><a href="facturas.html">Facturas</a></li>
                    <li><a href="perfil.html">Perfil</a></li>
                    <li><a href="direcciones.html">Direcciones</a></li>
                    <li><a href="tarjetas.html">Tarjetas</a></li>
                    <li><a href="#">Darme de baja</a></li>
                    <li><a href="#">Salir</a></li>
                </ul>
            </nav>
            <div class="w-100">
                <div class="mt-4">
                    <h3>Historial de Pedidos</h3>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-pedidos">
                            <!-- Pedidos se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
        <!-- Footer -->
        <footer class="text-center text-lg-start bg-body-tertiary text-muted mt-5">
            <div class="container text-center text-md-start mt-5">
                <div class="row">
                    <div class="col-md-4 col-lg-3 mx-auto mb-4">
                        <h6 class="text-uppercase fw-bold mb-4">Contacto</h6>
                        <p><i class="fas fa-home me-3"></i>c/ Jose Sanchez Rubio, 2, Torrelodones</p>
                        <p><i class="fas fa-envelope me-3"></i> contacto@caballogoloso.com</p>
                        <p><i class="fas fa-phone me-3"></i>91 859 67 11</p>
                    </div>
                </div>
            </div>
            <div class="text-center p-4" style="background-color: rgba(0, 0, 0, 0.05);">
                © 2025 Copyright:
                <a class="text-reset fw-bold" href="#">Pastelería El Caballo Goloso</a>
            </div>
        </footer>
    
        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    const response = await fetch('/api/usuario', { credentials: 'include' });
                    if (!response.ok) throw new Error('No autenticado');
                    
                    const user = await response.json();
                    document.getElementById('welcome-message').textContent = `Bienvenido, ${user.nombre}`;
                    cargarPedidos(user.id);
                } catch (error) {
                    alert("Debes iniciar sesión para ver tus pedidos.");
                    window.location.href = "/login.html";
                }
            });
            
            async function cargarPedidos(userId) {
                try {
                    const response = await fetch(`/api/pedidos?userId=${userId}`);
                    if (!response.ok) throw new Error('Error al obtener pedidos');
                    
                    const pedidos = await response.json();
                    const ordersTable = document.getElementById("lista-pedidos");
                    ordersTable.innerHTML = "";
                    
                    if (pedidos.length === 0) {
                        ordersTable.innerHTML = "<tr><td colspan='5' class='text-center'>No tienes pedidos aún.</td></tr>";
                    }
                    
                    pedidos.forEach(order => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.id}</td>
                            <td>${order.fecha}</td>
                            <td>$${order.total.toFixed(2)}</td>
                            <td>${order.estado}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="verPedido(${order.id})">Ver</button>
                            </td>
                        `;
                        ordersTable.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error cargando pedidos:', error);
                }
            }
            
            function verPedido(id) {
                alert("Mostrando detalles del pedido " + id);
            }
            
            function logout() {
                fetch('/api/logout', { method: 'POST', credentials: 'include' })
                    .then(() => {
                        alert("Has cerrado sesión correctamente.");
                        window.location.href = "/login.html";
                    })
                    .catch(error => console.error('Error al cerrar sesión:', error));
            }
        </script>
</body>
</html>