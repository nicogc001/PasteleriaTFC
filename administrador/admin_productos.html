<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Productos - Admin</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="../styles/main.css" rel="stylesheet" />
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">El Caballo Goloso</a>
      <div class="d-flex align-items-center">
        <a class="btn btn-outline-dark me-2" href="dashboard.html">Dashboard</a>
        <button class="btn btn-danger" onclick="logout()">Cerrar sesión</button>
      </div>
    </div>
  </nav>

  <main class="container mt-5">
    <h1 class="text-center mb-4">Agregar nuevo producto</h1>
    <nav class="me-4">
      <h3 class="text-danger">Menú</h3>
      <ul class="list-unstyled">
          <li><strong>Dashboard</strong></li>
          <li><a href="admin_pedidos.html">Pedidos</a></li>
          <li><a href="admin_usuarios.html">Usuarios</a></li>
          <li><a href="admin_productos.html">Productos</a></li>
          <li><a href="#" onclick="logout()">Cerrar sesión</a></li>
      </ul>
  </nav>

    <form id="formNuevoProducto" class="row g-3">
      <div class="col-md-6">
        <label for="nombre" class="form-label">Nombre del producto</label>
        <input type="text" class="form-control" id="nombre" required>
      </div>

      <div class="col-md-6">
        <label for="precio" class="form-label">Precio</label>
        <input type="number" step="0.01" class="form-control" id="precio" required>
      </div>

      <div class="col-12">
        <label for="descripcion" class="form-label">Descripción</label>
        <textarea class="form-control" id="descripcion" rows="2" required></textarea>
      </div>

      <div class="col-md-6">
        <label for="stock" class="form-label">Stock</label>
        <input type="number" class="form-control" id="stock" required>
      </div>

      <div class="col-md-6">
        <label for="imagen" class="form-label">URL de la imagen</label>
        <input type="url" class="form-control" id="imagen" required>
      </div>

      <div class="col-md-6">
        <label for="categoria" class="form-label">Categoría</label>
        <select class="form-select" id="categoria" required>
          <option value="">Selecciona una categoría</option>
          <option value="tartas">Tartas</option>
          <option value="bolleria">Bollería</option>
          <option value="salado">Salado</option>
          <option value="pasteleria">Pastelería</option>
          <option value="cafeteria">Cafetería</option>
        </select>
      </div>

      <div class="col-12 text-center">
        <button type="submit" class="btn btn-success">Crear producto</button>
      </div>
    </form>

    <hr class="my-5">

    <h2 class="text-center mb-4">Listado de productos</h2>
    <div class="table-responsive">
      <table class="table table-bordered" id="tablaProductos">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Stock</th>
            <th>Actualizar Stock</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    const token = localStorage.getItem('token');
    const API_URL = 'https://pasteleriatfc-back-igmg.onrender.com/api/productos';

    document.getElementById('formNuevoProducto').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nuevoProducto = {
        nombre: document.getElementById('nombre').value,
        precio: parseFloat(document.getElementById('precio').value),
        descripcion: document.getElementById('descripcion').value,
        stock: parseInt(document.getElementById('stock').value),
        imagen: document.getElementById('imagen').value,
        categoria: document.getElementById('categoria').value
      };

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(nuevoProducto)
        });

        if (!res.ok) throw new Error('Error al crear el producto');

        alert('✅ Producto creado correctamente');
        document.getElementById('formNuevoProducto').reset();
        cargarProductos();
      } catch (err) {
        console.error(err);
        alert('❌ Error al crear el producto');
      }
    });

    async function eliminarProducto(id) {
    if (!confirm('¿Estás seguro de que deseas eliminar este producto?')) return;

    try {
      const res = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!res.ok) throw new Error('Error al eliminar el producto');

      alert('✅ Producto eliminado');
      cargarProductos();
    } catch (err) {
      console.error(err);
      alert('❌ Error al eliminar el producto');
    }
  }


    async function cargarProductos() {
      try {
        const res = await fetch(API_URL, {
          headers: { 'Authorization': `Bearer ${token}` },
        });
        const productos = await res.json();
        const tbody = document.querySelector('#tablaProductos tbody');
        tbody.innerHTML = '';

        productos.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>${p.categoria}</td>
          <td>${p.stock}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editarProducto(${p.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.id})">Eliminar</button>
          </td>
        `;


          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('❌ Error al cargar productos:', err);
      }
    }

    function crearProducto(e) {
    e.preventDefault();

    const nuevoProducto = {
      nombre: document.getElementById('nombre').value,
      precio: parseFloat(document.getElementById('precio').value),
      descripcion: document.getElementById('descripcion').value,
      stock: parseInt(document.getElementById('stock').value),
      imagen: document.getElementById('imagen').value,
      categoria: document.getElementById('categoria').value
    };

    fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(nuevoProducto)
    })
    .then(res => {
      if (!res.ok) throw new Error('Error al crear el producto');
      return res.json();
    })
    .then(() => {
      alert('✅ Producto creado correctamente');
      document.getElementById('formNuevoProducto').reset();
      cargarProductos();
    })
    .catch(err => {
      console.error(err);
      alert('❌ Error al crear el producto');
    });
  }

  // Asegura que el submit inicial sea para crear
  document.getElementById('formNuevoProducto').onsubmit = crearProducto;
    async function actualizarStock(id) {
      const nuevoStock = document.getElementById(`stock-${id}`).value;
      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ stock: parseInt(nuevoStock) })
        });

        if (!res.ok) throw new Error('Error al actualizar el stock');

        alert('✅ Stock actualizado');
        cargarProductos();
      } catch (err) {
        console.error(err);
        alert('❌ Error actualizando stock');
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = '../login.html';
    }

    // Cargar productos al cargar la página
    document.addEventListener('DOMContentLoaded', cargarProductos);

    async function editarProducto(id) {
  try {
    const res = await fetch(`${API_URL}/${id}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const producto = await res.json();

    // Rellena el formulario con los datos existentes
    document.getElementById('nombre').value = producto.nombre;
    document.getElementById('precio').value = producto.precio;
    document.getElementById('descripcion').value = producto.descripcion;
    document.getElementById('stock').value = producto.stock;
    document.getElementById('imagen').value = producto.imagen;
    document.getElementById('categoria').value = producto.categoria;

    // Cambia el botón de crear por uno de guardar cambios
    const btnCrear = document.querySelector('#formNuevoProducto button');
    btnCrear.textContent = 'Guardar cambios';
    btnCrear.classList.remove('btn-success');
    btnCrear.classList.add('btn-warning');

    // Actualiza el evento submit para editar en vez de crear
    document.getElementById('formNuevoProducto').onsubmit = async (e) => {
      e.preventDefault();

      const productoActualizado = {
        nombre: document.getElementById('nombre').value,
        precio: parseFloat(document.getElementById('precio').value),
        descripcion: document.getElementById('descripcion').value,
        stock: parseInt(document.getElementById('stock').value),
        imagen: document.getElementById('imagen').value,
        categoria: document.getElementById('categoria').value
      };

      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(productoActualizado)
        });

        if (!res.ok) throw new Error('Error al actualizar el producto');

        alert('✅ Producto actualizado');
        document.getElementById('formNuevoProducto').reset();
        cargarProductos();

        // Restaurar botón a "Crear producto"
        btnCrear.textContent = 'Crear producto';
        btnCrear.classList.remove('btn-warning');
        btnCrear.classList.add('btn-success');
        document.getElementById('formNuevoProducto').onsubmit = crearProducto;
      } catch (err) {
        console.error(err);
        alert('❌ Error al actualizar el producto');
      }
    };
  } catch (err) {
    console.error(err);
    alert('❌ Error al obtener producto');
  }
}

  </script>
</body>

</html>
