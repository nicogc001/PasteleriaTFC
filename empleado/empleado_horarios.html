<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Horarios - Empleado</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="/styles/main.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <main class="container mt-5">
    <h1 class="text-center">Mis Horarios</h1>
    <div class="row justify-content-center">
      <div class="col-md-10">

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card text-center bg-light p-3">
              <h5>Estado de hoy</h5>
              <p id="estado-entrada" class="mb-1">Entrada: <span class="badge bg-secondary">Pendiente</span></p>
              <p id="estado-salida">Salida: <span class="badge bg-secondary">Pendiente</span></p>
            </div>
          </div>
          <div class="col-md-6 d-flex align-items-end justify-content-end">
            <button class="btn btn-success me-2" onclick="registrarEntrada()">Registrar entrada</button>
            <button class="btn btn-danger" onclick="registrarSalida()">Registrar salida</button>
          </div>
        </div>

        <div class="d-flex justify-content-end mb-3">
          <label for="fechaFiltro" class="form-label me-2">Filtrar por fecha:</label>
          <input type="date" id="fechaFiltro" class="form-control" style="max-width: 200px;">
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Fecha</th>
                <th>Hora Entrada</th>
                <th>Hora Salida</th>
                <th>Tiempo Trabajado</th>
                <th>Ubicación</th>
              </tr>
            </thead>
            <tbody id="tabla-horarios">
              <!-- Datos dinámicos -->
            </tbody>
          </table>
        </div>

        <div class="text-center mt-4">
          <button class="btn btn-secondary" onclick="logout()">Cerrar sesión</button>
        </div>

      </div>
    </div>
  </main>

  <footer class="text-center text-lg-start bg-body-tertiary text-muted mt-5 p-3">
    © 2025 Pastelería El Caballo Goloso
  </footer>

  <script>
    const token = localStorage.getItem('token');
    const API_HORARIOS = 'https://pasteleriatfc-back-igmg.onrender.com/api/registro-horario/mis-horarios';
    const API_ENTRADA = 'https://pasteleriatfc-back-igmg.onrender.com/api/registro-horario/entrada';
    const API_SALIDA = 'https://pasteleriatfc-back-igmg.onrender.com/api/registro-horario/salida';

    document.addEventListener('DOMContentLoaded', async () => {
      if (!token) {
        alert("Debes iniciar sesión.");
        return window.location.href = '../login.html';
      }

      await cargarHorarios();
      document.getElementById('fechaFiltro').addEventListener('change', cargarHorarios);
    });

    function calcularDiferencia(horaEntrada, horaSalida) {
      if (!horaEntrada || !horaSalida) return '-';
      horaEntrada = horaEntrada.slice(0, 5);
      horaSalida = horaSalida.slice(0, 5);
      const [h1, m1] = horaEntrada.split(':').map(Number);
      const [h2, m2] = horaSalida.split(':').map(Number);
      let minutos = (h2 * 60 + m2) - (h1 * 60 + m1);
      if (minutos < 0) return '-';
      const horas = Math.floor(minutos / 60);
      minutos = minutos % 60;
      return `${horas}h ${minutos}min`;
    }

    async function cargarHorarios() {
      try {
        const fecha = document.getElementById('fechaFiltro').value;
        const url = fecha ? `${API_HORARIOS}?fecha=${fecha}` : API_HORARIOS;

        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al obtener horarios');

        const horarios = await res.json();
        const tbody = document.getElementById('tabla-horarios');
        tbody.innerHTML = '';

        let estadoHoy = horarios.find(h => h.fecha === new Date().toISOString().split('T')[0]);

        document.getElementById('estado-entrada').innerHTML = `Entrada: <span class="badge bg-${estadoHoy?.horaEntrada ? 'success' : 'secondary'}">${estadoHoy?.horaEntrada || 'Pendiente'}</span>`;
        document.getElementById('estado-salida').innerHTML = `Salida: <span class="badge bg-${estadoHoy?.horaSalida ? 'success' : 'secondary'}">${estadoHoy?.horaSalida || 'Pendiente'}</span>`;

        horarios.forEach(horario => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${horario.fecha}</td>
            <td>${horario.horaEntrada || '-'}</td>
            <td>${horario.horaSalida || '-'}</td>
            <td>${calcularDiferencia(horario.horaEntrada, horario.horaSalida)}</td>
            <td>${horario.tienda || 'Tienda principal'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error cargando horarios:', err);
        alert('No se pudo cargar los horarios.');
      }
    }

    async function registrarEntrada() {
      try {
        const res = await fetch(API_ENTRADA, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'Error al registrar entrada');
        alert(data.message);
        cargarHorarios();
      } catch (err) {
        console.error('❌ Error registrando entrada:', err);
        alert(err.message);
      }
    }

    async function registrarSalida() {
      try {
        const res = await fetch(API_SALIDA, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'Error al registrar salida');
        alert(data.message);
        cargarHorarios();
      } catch (err) {
        console.error('❌ Error registrando salida:', err);
        alert(err.message);
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = '../login.html';
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.0/mdb.min.js"></script>
</body>
</html>
